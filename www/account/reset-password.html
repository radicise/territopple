<!DOCTYPE html>
<html>
    <head>
        <script src="/_icons.js"></script>
        <title>Password Reset - Territopple</title>
    </head>
    <body>
        <label for="pw">Password: </label>
        <input type="password" id="pw"><br>
        <label for="cpw">Confirm Password: </label>
        <input type="password" id="cpw"><br>
        <input type="button" id="submit" value="submit"><br>
        <p id="message-area"></p>
        <script>
            /**@type {HTMLInputElement} */
            const pw = document.getElementById("pw");
            /**@type {HTMLInputElement} */
            const cpw = document.getElementById("cpw");
            /**@type {HTMLInputElement} */
            const submit = document.getElementById("submit");
            /**@type {HTMLParagraphElement} */
            const msgarea = document.getElementById("message-area");
            submit.onclick = () => {
                if (!pw.value || !cpw.value) {
                    msgarea.textContent = "Error: must enter password into both fields";
                    return;
                }
                if (pw.value !== cpw.value) {
                    msgarea.textContent = "Error: passwords must match";
                    return;
                }
                const prom = fetch(`https://${document.location.hostname}/acc/reset-password-wcode`, {method:"POST",headers:[["Content-Type","application/json"]],body:JSON.stringify({code:new URL(window.location.href).searchParams.get("code"),pw:pw.value})});
                msgarea.textContent = "Sending reset request";
                prom.then(async v => {
                    switch (v.status) {
                        case 200: {
                            msgarea.textContent = "Password reset successfully, you will be redirected to the login page shortly";
                            setTimeout(() => {window.location.href=`https://${document.location.hostname}/account/login`},2000);
                            return;
                        }
                        case 400: {
                            msgarea.textContent = "Error with request, please send an email to reports@territopple.net with the values entered into the password fields";
                            return;
                        }
                        case 403: {
                            msgarea.textContent = "Error: reset code expired, please make another reset request and try again";
                            return;
                        }
                        case 500: {
                            msgarea.textContent = `Error: ${await (await v.blob()).text()}`;
                            return;
                        }
                        default: {
                            msgarea.textContent = "Error: the server is not currently available, please try again later";
                            return;
                        }
                    }
                });
            };
        </script>
    </body>
</html>
